<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Verificação de Carga - Motorista</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <!-- PWA Basic Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3lzdGVtYSBkZSBWZXJpZmljYWNhw6NvIGRlIENhcmdhIiwic2hvcnRfbmFtZSI6IlZlcmlmaWNhw6NvIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjM2I4MmY2In0=">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        :root {
            --primary: #1a1d23;
            --secondary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #f3f4f6;
            --dark: #111827;
            --text: #374151;
            --background: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            font-size: 16px;
            line-height: 1.5;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: var(--background);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin: 0 auto;
        }

        /* Login Screen */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            padding: 40px;
            width: 100%;
            max-width: 420px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--secondary), #8b5cf6);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            color: white;
            font-size: 2rem;
        }

        .login-container h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .login-container p {
            color: var(--text);
            margin-bottom: 30px;
            opacity: 0.8;
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .login-container input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s;
            background: var(--light);
        }

        .login-container input:focus {
            outline: none;
            border-color: var(--secondary);
            background: white;
        }

        .login-button {
            background: linear-gradient(135deg, var(--secondary), #8b5cf6);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .login-button:active {
            transform: translateY(0);
        }

        .login-error {
            color: var(--danger);
            margin-top: 20px;
            padding: 12px;
            background: #fee2e2;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary), #2d3748);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-logo {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .user-role {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            padding: 30px;
        }

        /* Upload Section */
        .upload-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--secondary), #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: var(--light);
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--secondary);
            background: #f0f9ff;
        }

        .upload-area.dragover {
            border-color: var(--secondary);
            background: #dbeafe;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .upload-button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .upload-button:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .file-info {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--border);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--danger);
            font-size: 1.2rem;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 0.85rem;
            color: var(--text);
            opacity: 0.7;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text);
            opacity: 0.7;
            font-weight: 500;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .stat-icon.total {
            background: #dbeafe;
            color: var(--secondary);
        }

        .stat-icon.verified {
            background: #d1fae5;
            color: var(--success);
        }

        .stat-icon.pending {
            background: #fed7aa;
            color: var(--warning);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-change {
            font-size: 0.75rem;
            color: var(--success);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Progress Bar */
        .progress-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-weight: 600;
            color: var(--primary);
        }

        .progress-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--secondary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-bar {
            height: 12px;
            background: var(--light);
            border-radius: 100px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), #8b5cf6);
            border-radius: 100px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Scanner Section */
        .scanner-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 992px) {
            .scanner-grid {
                grid-template-columns: 1fr;
            }
        }

        .scanner-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .scanner-container {
            position: relative;
            height: 400px;
            background: var(--primary);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #qr-reader {
            width: 100%;
            height: 100%;
        }

        .scanner-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1d23, #2d3748);
            color: white;
            text-align: center;
            padding: 20px;
        }

        .scanner-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .scanner-placeholder h3 {
            font-size: 1.25rem;
            margin-bottom: 10px;
        }

        .scanner-placeholder p {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .scanner-controls {
            display: flex;
            gap: 12px;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .control-btn.primary {
            background: var(--success);
            color: white;
        }

        .control-btn.primary:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .control-btn.secondary {
            background: var(--warning);
            color: white;
        }

        .control-btn.secondary:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .control-btn.stop {
            background: var(--danger);
            color: white;
        }

        /* Manual Input */
        .manual-input-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #bae6fd;
        }

        .input-field {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .input-field input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-field input:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .verify-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .verify-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        /* Feedback Messages */
        .feedback {
            padding: 12px 16px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        .feedback.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .feedback.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .feedback.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        /* Product List */
        .products-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .product-table {
            width: 100%;
            border-collapse: collapse;
        }

        .product-table thead {
            background: var(--light);
        }

        .product-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .product-table tbody tr {
            border-bottom: 1px solid var(--border);
            transition: all 0.3s;
        }

        .product-table tbody tr:hover {
            background: var(--light);
        }

        .product-table td {
            padding: 14px 12px;
            font-size: 0.9rem;
        }

        .product-number {
            font-weight: 600;
            color: var(--primary);
        }

        .product-code {
            font-family: 'Courier New', monospace;
            background: var(--light);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.verified {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 30px;
        }

        .action-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--success), #10b981);
            color: white;
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .action-btn.secondary {
            background: var(--light);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .action-btn.secondary:hover {
            background: white;
            border-color: var(--secondary);
        }

        /* Report Section */
        .report-container {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 16px;
            padding: 30px;
            margin: 25px;
            border: 1px solid #86efac;
            display: none;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .report-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .report-subtitle {
            color: var(--text);
            opacity: 0.7;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-stat {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .report-stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .report-stat-label {
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.7;
        }

        /* Animations */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        .pulse {
            animation: pulse 1s;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .search-box {
                width: 100%;
            }

            .products-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .product-table {
                font-size: 0.85rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }

            .scanner-controls {
                flex-direction: column;
            }

            .control-btn {
                width: 100%;
            }

            .input-field {
                flex-direction: column;
            }

            .verify-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 5px;
            }

            .main-content {
                padding: 15px;
            }

            .app-header {
                padding: 10px 15px;
            }

            .app-title {
                display: none;
            }

            .scanner-container {
                height: 250px;
            }

            .scanner-card {
                padding: 15px;
            }

            .manual-input-card {
                padding: 15px;
            }

            .upload-card,
            .progress-card,
            .products-card {
                padding: 15px;
            }

            .report-container {
                margin: 10px;
                padding: 20px;
            }

            .card-header {
                gap: 8px;
                margin-bottom: 15px;
            }

            .card-icon {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }

            .card-title {
                font-size: 1rem;
            }

            .upload-area {
                padding: 20px;
            }

            .upload-icon {
                font-size: 2.5rem;
            }

            .stats-grid {
                gap: 15px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.75rem;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
            border-left: 4px solid var(--secondary);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-message {
            flex: 1;
            font-size: 0.9rem;
        }

        .toast-close {
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* A11y Improvements */
        .control-btn[role="button"] {
            role: button;
        }

        .progress-bar[role="progressbar"] {
            role: progressbar;
            aria-valuemin: 0;
            aria-valuemax: 100;
        }

        .feedback[aria-live="polite"] {
            aria-live: polite;
        }
    </style>
</head>

<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-truck-loading"></i>
            </div>
            <h1>Sistema de Verificação</h1>
            <p>Faça login para continuar</p>
            
            <div class="input-group">
                <i class="fas fa-user"></i>
                <input type="text" id="username" placeholder="Usuário" autocomplete="username">
            </div>
            
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="password" placeholder="Senha" autocomplete="current-password">
            </div>
            
            <button class="login-button" id="loginButton" aria-label="Entrar no sistema">
                <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
            
            <div id="login-error" class="login-error hidden">
                <i class="fas fa-exclamation-circle"></i>
                <span>Usuário ou senha inválidos</span>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="container hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="app-logo">
                    <i class="fas fa-truck"></i>
                </div>
                <h1 class="app-title">Sistema de Verificação de Carga</h1>
            </div>
            
            <div class="user-section">
                <div class="user-avatar" id="userAvatar">M</div>
                <div class="user-details">
                    <span class="user-name" id="userName">Motorista</span>
                    <span class="user-role">Motorista</span>
                </div>
                <button class="logout-btn" id="logoutBtn" aria-label="Sair da sessão">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Upload Section -->
            <div class="upload-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h2 class="card-title">Carregar Roteiro de Entregas</h2>
                </div>
                
                <div class="upload-area" id="uploadArea" tabindex="0" role="button" aria-label="Área para upload de PDF">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <h3>Arraste e solte seu PDF aqui</h3>
                    <p>ou</p>
                    <button class="upload-button" id="uploadButton" aria-label="Selecionar arquivo PDF">
                        <i class="fas fa-upload"></i> Selecionar Arquivo
                    </button>
                    <input type="file" id="fileInput" accept=".pdf" class="hidden">
                </div>
                
                <div id="fileInfo" class="file-info hidden">
                    <div class="file-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="file-details">
                        <div class="file-name" id="fileName">documento.pdf</div>
                        <div class="file-size" id="fileSize">2.5 MB</div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Total de Itens</div>
                            <div class="stat-value" id="totalItems">0</div>
                        </div>
                        <div class="stat-icon total">
                            <i class="fas fa-box"></i>
                        </div>
                    </div>
                    <div class="stat-change">
                        <i class="fas fa-info-circle"></i> Carregados do PDF
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Verificados</div>
                            <div class="stat-value" id="verifiedItems">0</div>
                        </div>
                        <div class="stat-icon verified">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                    <div class="stat-change">
                        <i class="fas fa-arrow-up"></i> Escaneados com sucesso
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-label">Pendentes</div>
                            <div class="stat-value" id="pendingItems">0</div>
                        </div>
                        <div class="stat-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <div class="stat-change">
                        <i class="fas fa-exclamation"></i> Aguardando verificação
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-card">
                <div class="progress-header">
                    <span class="progress-title">Progresso da Verificação</span>
                    <span class="progress-percentage" id="progressPercent" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">0%</span>
                </div>
                <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>

            <!-- Scanner and Manual Input -->
            <div class="scanner-grid">
                <!-- Scanner Section -->
                <div class="scanner-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <h2 class="card-title">Scanner de Código</h2>
                    </div>
                    
                    <div class="scanner-container" id="scannerContainer">
                        <div id="qr-reader">
                            <div class="scanner-placeholder hidden" id="scannerPlaceholder">
                                <i class="fas fa-camera"></i>
                                <h3>Scanner Pronto</h3>
                                <p>Clique em "Iniciar" para escanear códigos</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="scanner-controls">
                        <button class="control-btn primary" id="startScanBtn" role="button" aria-label="Iniciar scanner de QR code">
                            <i class="fas fa-play"></i> Iniciar Scanner
                        </button>
                        <button class="control-btn secondary" id="manualBtn" role="button" aria-label="Alternar para entrada manual">
                            <i class="fas fa-keyboard"></i> Entrada Manual
                        </button>
                    </div>
                    
                    <div id="scanFeedback" class="feedback hidden" aria-live="polite"></div>
                </div>

                <!-- Manual Input Section -->
                <div class="scanner-card manual-input-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-keyboard"></i>
                        </div>
                        <h2 class="card-title">Entrada Manual</h2>
                    </div>
                    
                    <p style="margin-bottom: 20px; color: var(--text); opacity: 0.8;">
                        Digite o código do produto para verificação manual
                    </p>
                    
                    <div class="input-field">
                        <input type="text" id="manualCode" placeholder="Digite o código aqui..." aria-label="Código do produto">
                        <button class="verify-btn" id="verifyBtn" role="button" aria-label="Verificar código manualmente">
                            <i class="fas fa-check"></i> Verificar
                        </button>
                    </div>
                    
                    <div id="manualFeedback" class="feedback hidden" aria-live="polite"></div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: var(--light); border-radius: 12px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary);">
                            <i class="fas fa-lightbulb"></i> Dicas Rápidas
                        </h4>
                        <ul style="color: var(--text); opacity: 0.8; font-size: 0.9rem; padding-left: 20px;">
                            <li>Use o scanner para verificação mais rápida</li>
                            <li>Digite o código exatamente como aparece no pacote</li>
                            <li>Códigos verificados aparecerão em verde na lista</li>
                            <li>Você pode pesquisar produtos na tabela abaixo</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Products List -->
            <div class="products-card">
                <div class="products-header">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <h2 class="card-title">Lista de Produtos</h2>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Buscar produto..." aria-label="Buscar produtos">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Código do Produto</th>
                                <th>Status</th>
                                <th>Data/Hora</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody" aria-live="polite">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px; color: var(--text); opacity: 0.5;">
                                    <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                    <p>Nenhum produto carregado</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn secondary" id="exportBtn" aria-label="Exportar dados da verificação">
                    <i class="fas fa-download"></i> Exportar Dados
                </button>
                <button class="action-btn primary" id="finalizeBtn" aria-label="Finalizar verificação">
                    <i class="fas fa-flag-checkered"></i> Finalizar Verificação
                </button>
            </div>

            <!-- Report Section -->
            <div class="report-container" id="reportContainer">
                <div class="report-header">
                    <h2 class="report-title">
                        <i class="fas fa-trophy"></i> Verificação Concluída!
                    </h2>
                    <p class="report-subtitle">Aqui está o resumo da sua verificação</p>
                </div>
                
                <div class="report-stats">
                    <div class="report-stat">
                        <div class="report-stat-value" style="color: var(--success);" id="reportVerified">0</div>
                        <div class="report-stat-label">Itens Verificados</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value" style="color: var(--warning);" id="reportPending">0</div>
                        <div class="report-stat-label">Itens Pendentes</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-stat-value" style="color: var(--secondary);" id="reportPercent">0%</div>
                        <div class="report-stat-label">Taxa de Conclusão</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn secondary" id="downloadReportBtn" aria-label="Baixar relatório em PDF">
                        <i class="fas fa-file-pdf"></i> Baixar Relatório PDF
                    </button>
                    <button class="action-btn primary" id="finishBtn" aria-label="Finalizar rota">
                        <i class="fas fa-check-circle"></i> Finalizar Rota
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true">
        <div class="modal-content">
            <span class="modal-close" id="modalClose" aria-label="Fechar modal">&times;</span>
            <h3 id="modalTitle">Título do Modal</h3>
            <p id="modalBody">Conteúdo do modal</p>
            <div style="margin-top: 20px; text-align: right;">
                <button class="action-btn secondary" id="modalCancel" aria-label="Cancelar ação">Cancelar</button>
                <button class="action-btn primary" id="modalConfirm" aria-label="Confirmar ação">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Cargo Verification System with Improvements
        class CargoVerificationSystem {
            constructor() {
                this.loginAttempts = 0;
                this.maxLoginAttempts = 3;
                this.initializeElements();
                this.initializeState();
                this.attachEventListeners();
                this.initializeDatabase();
            }

            initializeElements() {
                // Login Elements
                this.loginScreen = document.getElementById('login-screen');
                this.appScreen = document.getElementById('app');
                this.usernameInput = document.getElementById('username');
                this.passwordInput = document.getElementById('password');
                this.loginButton = document.getElementById('loginButton');
                this.loginError = document.getElementById('login-error');
                
                // User Elements
                this.userAvatar = document.getElementById('userAvatar');
                this.userName = document.getElementById('userName');
                this.logoutBtn = document.getElementById('logoutBtn');
                
                // Upload Elements
                this.uploadArea = document.getElementById('uploadArea');
                this.uploadButton = document.getElementById('uploadButton');
                this.fileInput = document.getElementById('fileInput');
                this.fileInfo = document.getElementById('fileInfo');
                this.fileName = document.getElementById('fileName');
                this.fileSize = document.getElementById('fileSize');
                
                // Stats Elements
                this.totalItemsEl = document.getElementById('totalItems');
                this.verifiedItemsEl = document.getElementById('verifiedItems');
                this.pendingItemsEl = document.getElementById('pendingItems');
                this.progressBar = document.getElementById('progressBar');
                this.progressPercent = document.getElementById('progressPercent');
                
                // Scanner Elements
                this.scannerContainer = document.getElementById('scannerContainer');
                this.scannerPlaceholder = document.getElementById('scannerPlaceholder');
                this.startScanBtn = document.getElementById('startScanBtn');
                this.manualBtn = document.getElementById('manualBtn');
                this.scanFeedback = document.getElementById('scanFeedback');
                
                // Manual Input Elements
                this.manualCode = document.getElementById('manualCode');
                this.verifyBtn = document.getElementById('verifyBtn');
                this.manualFeedback = document.getElementById('manualFeedback');
                
                // Product List Elements
                this.searchInput = document.getElementById('searchInput');
                this.productTableBody = document.getElementById('productTableBody');
                
                // Action Elements
                this.exportBtn = document.getElementById('exportBtn');
                this.finalizeBtn = document.getElementById('finalizeBtn');
                
                // Report Elements
                this.reportContainer = document.getElementById('reportContainer');
                this.reportVerified = document.getElementById('reportVerified');
                this.reportPending = document.getElementById('reportPending');
                this.reportPercent = document.getElementById('reportPercent');
                this.downloadReportBtn = document.getElementById('downloadReportBtn');
                this.finishBtn = document.getElementById('finishBtn');
                
                // Modal Elements
                this.modal = document.getElementById('modal');
                this.modalClose = document.getElementById('modalClose');
                this.modalTitle = document.getElementById('modalTitle');
                this.modalBody = document.getElementById('modalBody');
                this.modalCancel = document.getElementById('modalCancel');
                this.modalConfirm = document.getElementById('modalConfirm');
                
                // Toast Container
                this.toastContainer = document.getElementById('toastContainer');
            }

            initializeState() {
                this.currentUser = null;
                this.deliveryData = [];
                this.verifiedItems = 0;
                this.totalItems = 0;
                this.html5QrCode = null;
                this.isScanning = false;
                this.audioContext = null;
            }

            async initializeDatabase() {
                // Initialize users if not exists (with hashed passwords)
                if (!localStorage.getItem('users')) {
                    const users = {
                        "admin": { passwordHash: await this.hashPassword("admin123"), name: "Administrador", role: "admin" },
                        "motorista1": { passwordHash: await this.hashPassword("123456"), name: "João Silva", role: "driver" },
                        "motorista2": { passwordHash: await this.hashPassword("654321"), name: "Maria Santos", role: "driver" },
                        "carlos": { passwordHash: await this.hashPassword("cargo123"), name: "Carlos Pereira", role: "driver" }
                    };
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // Initialize routes storage
                if (!localStorage.getItem('routes')) {
                    localStorage.setItem('routes', JSON.stringify({}));
                }
                
                // Initialize verification history
                if (!localStorage.getItem('verificationHistory')) {
                    localStorage.setItem('verificationHistory', JSON.stringify([]));
                }
            }

            attachEventListeners() {
                // Login Events
                this.loginButton.addEventListener('click', () => this.handleLogin());
                this.passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleLogin();
                });
                this.logoutBtn.addEventListener('click', () => this.handleLogout());
                
                // Upload Events
                this.uploadButton.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.uploadArea.addEventListener('dragleave', () => this.handleDragLeave());
                this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));
                this.uploadArea.addEventListener('click', () => this.fileInput.click());
                this.uploadArea.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.fileInput.click();
                });
                
                // Scanner Events
                this.startScanBtn.addEventListener('click', () => this.toggleScanner());
                this.manualBtn.addEventListener('click', () => this.focusManualInput());
                
                // Manual Input Events
                this.verifyBtn.addEventListener('click', () => this.verifyManualCode());
                this.manualCode.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.verifyManualCode();
                });
                
                // Search Event
                this.searchInput.addEventListener('input', () => this.filterProducts());
                
                // Action Events
                this.exportBtn.addEventListener('click', () => this.exportData());
                this.finalizeBtn.addEventListener('click', () => this.showFinalReport());
                this.downloadReportBtn.addEventListener('click', () => this.generatePDFReport());
                this.finishBtn.addEventListener('click', () => this.finishRoute());
                
                // Modal Events
                this.modalClose.addEventListener('click', () => this.closeModal());
                this.modalCancel.addEventListener('click', () => this.closeModal());
            }

            // Authentication Methods
            async handleLogin() {
                if (++this.loginAttempts > this.maxLoginAttempts) {
                    this.showLoginError('Muitas tentativas. Recarregue a página.');
                    return;
                }

                const username = this.usernameInput.value.trim();
                const password = this.passwordInput.value.trim();
                
                if (!username || !password) {
                    this.showLoginError('Por favor, preencha todos os campos');
                    return;
                }
                
                try {
                    const users = JSON.parse(localStorage.getItem('users'));
                    const user = users[username];
                    const passwordHash = await this.hashPassword(password);
                    
                    if (user && user.passwordHash === passwordHash) {
                        if (user.role === 'admin') {
                            this.showLoginError('Acesso administrativo não permitido aqui');
                            return;
                        }
                        
                        this.currentUser = { ...user, username };
                        this.loginSuccess();
                    } else {
                        this.showLoginError('Usuário ou senha inválidos');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    this.showLoginError('Erro no sistema de login');
                }
            }

            async hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hash = await crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
            }

            loginSuccess() {
                this.loginScreen.classList.add('hidden');
                this.appScreen.classList.remove('hidden');
                
                // Update user info
                const initials = this.currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
                this.userAvatar.textContent = initials;
                this.userName.textContent = this.currentUser.name;
                
                // Load saved data
                this.loadUserData();
                
                // Show welcome toast
                this.showToast(`Bem-vindo, ${this.currentUser.name}!`, 'success');
                
                // Initialize audio context
                this.initAudioContext();
                
                // Reset attempts
                this.loginAttempts = 0;
            }

            showLoginError(message) {
                this.loginError.classList.remove('hidden');
                this.loginError.querySelector('span').textContent = message;
                this.playSound('error');
            }

            handleLogout() {
                this.showModal(
                    'Confirmar Saída',
                    'Tem certeza que deseja sair? Seus dados serão salvos.',
                    () => {
                        this.saveUserData();
                        this.performLogout();
                    }
                );
            }

            performLogout() {
                if (this.html5QrCode && this.isScanning) {
                    this.html5QrCode.stop();
                }
                
                this.appScreen.classList.add('hidden');
                this.loginScreen.classList.remove('hidden');
                
                // Clear inputs
                this.usernameInput.value = '';
                this.passwordInput.value = '';
                
                // Reset state
                this.initializeState();
                
                this.showToast('Logout realizado com sucesso', 'info');
            }

            // File Upload Methods
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file && file.type === 'application/pdf') {
                    this.processPDF(file);
                } else {
                    this.showToast('Por favor, selecione um arquivo PDF válido', 'error');
                }
            }

            handleDragOver(e) {
                e.preventDefault();
                this.uploadArea.classList.add('dragover');
            }

            handleDragLeave() {
                this.uploadArea.classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                this.uploadArea.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    this.processPDF(file);
                } else {
                    this.showToast('Por favor, arraste um arquivo PDF válido', 'error');
                }
            }

            async processPDF(file) {
                try {
                    this.showToast('Processando PDF...', 'info');
                    
                    // Show file info
                    this.fileName.textContent = file.name;
                    this.fileSize.textContent = this.formatFileSize(file.size);
                    this.fileInfo.classList.remove('hidden');
                    
                    // Process PDF with parallel pages
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    this.deliveryData = [];
                    let orderNumber = 1;
                    
                    // Parallel extraction from all pages
                    const pagesPromises = Array.from({length: pdf.numPages}, (_, i) => 
                        pdf.getPage(i + 1).then(page => page.getTextContent())
                    );
                    const pages = await Promise.all(pagesPromises);
                    const allText = pages.flatMap(p => p.items.map(item => item.str).join(' '));
                    
                    // Updated regex: Only 9-digit numeric codes to avoid confusing with CEP (8 digits)
                    const regex = /(\d{9})/g;
                    let match;
                    const uniqueCodes = new Set();
                    
                    while ((match = regex.exec(allText)) !== null) {
                        const code = match[1];
                        if (!uniqueCodes.has(code)) {
                            uniqueCodes.add(code);
                            this.deliveryData.push({
                                id: `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                                number: orderNumber++,
                                code: code,
                                verified: false,
                                verifiedAt: null
                            });
                        }
                    }
                    
                    // Update state
                    this.totalItems = this.deliveryData.length;
                    this.verifiedItems = 0;
                    
                    // Update UI
                    this.updateStats();
                    this.renderProductTable();
                    
                    // Save data
                    this.saveUserData();
                    
                    this.showToast(`PDF processado com sucesso! ${this.totalItems} itens carregados.`, 'success');
                    
                } catch (error) {
                    console.error('Error processing PDF:', error);
                    this.showToast('Erro ao processar o PDF. Verifique se o arquivo não está corrompido.', 'error');
                }
            }

            // Scanner Methods
            async toggleScanner() {
                if (!this.deliveryData.length) {
                    this.showToast('Por favor, carregue um PDF primeiro', 'warning');
                    return;
                }
                
                // Check camera support
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showToast('Câmera não suportada neste dispositivo', 'error');
                    return;
                }
                
                if (this.isScanning) {
                    this.stopScanner();
                } else {
                    this.startScanner();
                }
            }

            startScanner() {
                this.scannerPlaceholder.classList.add('hidden');
                this.startScanBtn.innerHTML = '<i class="fas fa-stop"></i> Parar Scanner';
                this.startScanBtn.classList.remove('primary');
                this.startScanBtn.classList.add('stop');
                
                this.html5QrCode = new Html5Qrcode("qr-reader");
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                };
                
                this.html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText) => this.onScanSuccess(decodedText)
                ).then(() => {
                    this.isScanning = true;
                }).catch(err => {
                    console.error('Scanner error:', err);
                    this.showToast('Erro ao acessar a câmera. Verifique permissões.', 'error');
                    this.resetScannerUI();
                });
            }

            stopScanner() {
                if (this.html5QrCode && this.isScanning) {
                    this.html5QrCode.stop().then(() => {
                        this.isScanning = false;
                        this.resetScannerUI();
                    });
                }
            }

            resetScannerUI() {
                this.scannerPlaceholder.classList.remove('hidden');
                this.startScanBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Scanner';
                this.startScanBtn.classList.remove('stop');
                this.startScanBtn.classList.add('primary');
            }

            onScanSuccess(decodedText) {
                this.validateCode(decodedText, 'scanner');
            }

            focusManualInput() {
                this.manualCode.focus();
                this.manualCode.select();
            }

            verifyManualCode() {
                const code = this.manualCode.value.trim();
                if (!code) {
                    this.showFeedback(this.manualFeedback, 'Digite um código válido', 'error');
                    return;
                }
                
                this.validateCode(code, 'manual');
            }

            validateCode(code, source) {
                try {
                    const item = this.deliveryData.find(d => d.code === code);
                    
                    if (!item) {
                        this.playSound('error');
                        const message = `Código ${code} não encontrado na lista`;
                        
                        if (source === 'scanner') {
                            this.showFeedback(this.scanFeedback, message, 'error');
                            this.scannerContainer.classList.add('pulse');
                        } else {
                            this.showFeedback(this.manualFeedback, message, 'error');
                        }
                        
                        this.showToast(message, 'error');
                        return;
                    }
                    
                    if (item.verified) {
                        this.playSound('warning');
                        const message = `Código ${code} já foi verificado`;
                        
                        if (source === 'scanner') {
                            this.showFeedback(this.scanFeedback, message, 'info');
                        } else {
                            this.showFeedback(this.manualFeedback, message, 'info');
                        }
                        
                        this.showToast(message, 'warning');
                        return;
                    }
                    
                    // Mark as verified
                    item.verified = true;
                    item.verifiedAt = new Date().toISOString();
                    this.verifiedItems++;
                    
                    // Update UI
                    this.updateStats();
                    this.renderProductTable();
                    
                    // Save data
                    this.saveUserData();
                    
                    // Success feedback
                    this.playSound('success');
                    const message = `✓ Código ${code} verificado com sucesso!`;
                    
                    if (source === 'scanner') {
                        this.showFeedback(this.scanFeedback, message, 'success');
                        this.scannerContainer.classList.add('pulse');
                    } else {
                        this.showFeedback(this.manualFeedback, message, 'success');
                        this.manualCode.value = '';
                    }
                    
                    this.showToast(message, 'success');
                    
                    // Check if all items verified
                    if (this.verifiedItems === this.totalItems) {
                        this.showToast('🎉 Parabéns! Todos os itens foram verificados!', 'success');
                        setTimeout(() => this.showFinalReport(), 1500);
                    }
                } catch (error) {
                    console.error('Validation error:', error);
                    this.showToast('Erro na validação do código', 'error');
                }
            }

            showFeedback(element, message, type) {
                element.classList.remove('hidden');
                element.className = `feedback ${type}`;
                element.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;
                
                setTimeout(() => {
                    element.innerHTML = '';
                    element.classList.add('hidden');
                }, 3000);
            }

            // UI Update Methods
            updateStats() {
                this.totalItemsEl.textContent = this.totalItems;
                this.verifiedItemsEl.textContent = this.verifiedItems;
                this.pendingItemsEl.textContent = this.totalItems - this.verifiedItems;
                
                const percentage = this.totalItems > 0 
                    ? Math.round((this.verifiedItems / this.totalItems) * 100) 
                    : 0;
                
                this.progressBar.style.width = `${percentage}%`;
                this.progressPercent.textContent = `${percentage}%`;
                this.progressPercent.setAttribute('aria-valuenow', percentage);
                this.progressBar.setAttribute('aria-valuenow', percentage);
            }

            renderProductTable() {
                if (!this.deliveryData.length) {
                    this.productTableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: var(--text); opacity: 0.5;">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>Nenhum produto carregado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const searchTerm = this.searchInput.value.toLowerCase();
                const filteredData = this.deliveryData.filter(item => 
                    item.code.toLowerCase().includes(searchTerm)
                );
                
                this.productTableBody.innerHTML = filteredData.map(item => `
                    <tr>
                        <td><span class="product-number">${item.number}</span></td>
                        <td><span class="product-code">${item.code}</span></td>
                        <td>
                            <span class="status-badge ${item.verified ? 'verified' : 'pending'}">
                                <i class="fas fa-${item.verified ? 'check-circle' : 'clock'}"></i>
                                ${item.verified ? 'Verificado' : 'Pendente'}
                            </span>
                        </td>
                        <td>${item.verifiedAt ? new Date(item.verifiedAt).toLocaleString('pt-BR') : '-'}</td>
                    </tr>
                `).join('');
            }

            filterProducts() {
                this.renderProductTable();
            }

            // Export/Import Methods
            exportData() {
                const data = {
                    user: this.currentUser.name,
                    date: new Date().toISOString(),
                    totalItems: this.totalItems,
                    verifiedItems: this.verifiedItems,
                    items: this.deliveryData
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `verificacao-${Date.now()}.json`;
                a.click();
                
                this.showToast('Dados exportados com sucesso!', 'success');
            }

            // Report Methods
            showFinalReport() {
                const pending = this.totalItems - this.verifiedItems;
                const percentage = this.totalItems > 0 
                    ? Math.round((this.verifiedItems / this.totalItems) * 100) 
                    : 0;
                
                this.reportVerified.textContent = this.verifiedItems;
                this.reportPending.textContent = pending;
                this.reportPercent.textContent = `${percentage}%`;
                
                this.reportContainer.style.display = 'block';
                this.reportContainer.scrollIntoView({ behavior: 'smooth' });
                
                // Save to history
                this.saveToHistory();
            }

            generatePDFReport() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.setTextColor(26, 29, 35);
                doc.text('Relatório de Verificação de Carga', 20, 20);
                
                // User Info
                doc.setFontSize(12);
                doc.setTextColor(55, 65, 81);
                doc.text(`Motorista: ${this.currentUser.name}`, 20, 35);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 43);
                doc.text(`Hora: ${new Date().toLocaleTimeString('pt-BR')}`, 20, 51);
                
                // Summary Box
                doc.setFillColor(243, 244, 246);
                doc.rect(20, 60, 170, 40, 'F');
                
                doc.setFontSize(14);
                doc.setTextColor(26, 29, 35);
                doc.text('Resumo da Verificação', 30, 75);
                
                doc.setFontSize(11);
                doc.text(`Total de Itens: ${this.totalItems}`, 30, 85);
                doc.text(`Itens Verificados: ${this.verifiedItems}`, 30, 92);
                doc.text(`Taxa de Conclusão: ${Math.round((this.verifiedItems / this.totalItems) * 100)}%`, 100, 85);
                doc.text(`Itens Pendentes: ${this.totalItems - this.verifiedItems}`, 100, 92);
                
                // Items List
                if (this.deliveryData.length > 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(26, 29, 35);
                    doc.text('Lista de Itens', 20, 115);
                    
                    // Table Header
                    doc.setFillColor(26, 29, 35);
                    doc.setTextColor(255, 255, 255);
                    doc.rect(20, 120, 170, 10, 'F');
                    doc.setFontSize(10);
                    doc.text('Nº', 25, 127);
                    doc.text('Código', 40, 127);
                    doc.text('Status', 120, 127);
                    doc.text('Data/Hora', 150, 127);
                    
                    // Table Content
                    doc.setTextColor(55, 65, 81);
                    let y = 137;
                    
                    this.deliveryData.forEach((item, index) => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        doc.text(String(item.number), 25, y);
                        doc.text(item.code, 40, y);
                        doc.text(item.verified ? 'Verificado' : 'Pendente', 120, y);
                        doc.text(item.verifiedAt ? new Date(item.verifiedAt).toLocaleString('pt-BR') : '-', 150, y);
                        
                        y += 7;
                    });
                }
                
                // Footer
                doc.setFontSize(9);
                doc.setTextColor(156, 163, 175);
                doc.text('Sistema de Verificação de Carga - Relatório Automático', 20, 285);
                doc.text(`Página 1`, 180, 285);
                
                // Save PDF
                doc.save(`relatorio-${this.currentUser.name.replace(' ', '-')}-${Date.now()}.pdf`);
                
                this.showToast('Relatório PDF gerado com sucesso!', 'success');
            }

            finishRoute() {
                this.showModal(
                    'Finalizar Rota',
                    'Tem certeza que deseja finalizar esta rota? Esta ação não pode ser desfeita.',
                    () => {
                        this.saveToHistory();
                        this.clearData();
                        this.showToast('Rota finalizada com sucesso!', 'success');
                        location.reload();
                    }
                );
            }

            // Data Persistence Methods
            saveUserData() {
                if (!this.currentUser) return;
                
                const routes = JSON.parse(localStorage.getItem('routes') || '{}');
                routes[this.currentUser.username] = {
                    deliveryData: this.deliveryData,
                    totalItems: this.totalItems,
                    verifiedItems: this.verifiedItems,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('routes', JSON.stringify(routes));
            }

            loadUserData() {
                if (!this.currentUser) return;
                
                const routes = JSON.parse(localStorage.getItem('routes') || '{}');
                const userData = routes[this.currentUser.username];
                
                if (userData) {
                    this.deliveryData = userData.deliveryData || [];
                    this.totalItems = userData.totalItems || 0;
                    this.verifiedItems = userData.verifiedItems || 0;
                    
                    this.updateStats();
                    this.renderProductTable();
                    
                    if (this.deliveryData.length > 0) {
                        this.fileInfo.classList.remove('hidden');
                        this.fileName.textContent = 'Dados carregados da sessão anterior';
                        this.fileSize.textContent = `${this.deliveryData.length} itens`;
                    }
                }
            }

            saveToHistory() {
                const history = JSON.parse(localStorage.getItem('verificationHistory') || '[]');
                history.push({
                    user: this.currentUser.name,
                    date: new Date().toISOString(),
                    totalItems: this.totalItems,
                    verifiedItems: this.verifiedItems,
                    percentage: Math.round((this.verifiedItems / this.totalItems) * 100)
                });
                localStorage.setItem('verificationHistory', JSON.stringify(history));
            }

            clearData() {
                this.deliveryData = [];
                this.totalItems = 0;
                this.verifiedItems = 0;
                
                const routes = JSON.parse(localStorage.getItem('routes') || '{}');
                delete routes[this.currentUser.username];
                localStorage.setItem('routes', JSON.stringify(routes));
            }

            // Utility Methods
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: 'check-circle',
                    error: 'times-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                
                toast.innerHTML = `
                    <i class="fas fa-${icons[type]} toast-icon"></i>
                    <span class="toast-message">${message}</span>
                    <i class="fas fa-times toast-close"></i>
                `;
                
                this.toastContainer.appendChild(toast);
                
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.remove();
                });
                
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }

            showModal(title, body, onConfirm) {
                this.modalTitle.textContent = title;
                this.modalBody.textContent = body;
                this.modal.style.display = 'flex';
                this.modal.focus(); // A11y: Trap focus
                
                this.modalConfirm.onclick = () => {
                    onConfirm();
                    this.closeModal();
                };
            }

            closeModal() {
                this.modal.style.display = 'none';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }

            initAudioContext() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }

            playSound(type) {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                switch(type) {
                    case 'success':
                        oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(1200, this.audioContext.currentTime + 0.1);
                        break;
                    case 'error':
                        oscillator.frequency.setValueAtTime(300, this.audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(200, this.audioContext.currentTime + 0.1);
                        break;
                    case 'warning':
                        oscillator.frequency.setValueAtTime(600, this.audioContext.currentTime);
                        break;
                }
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.3);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new CargoVerificationSystem();
        });

        // PWA Service Worker Registration (Basic)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4gZXZlbnQud2FpdFVudGlsKHNlbGYuc2tpcFdhaXRpbmdGb3N0aW5nKCl9KTs='); // Empty SW for now
        }
    </script>
</body>
</html>
